<script>
  <% if ("production" == Rails.env or "staging" == Rails.env) %>
    //Track loading of landing page separate from loading of app -->
    var shortLink = $.getUrlParam('awesm');
    if (typeof viaShortLink != 'undefined') { shortLink = 'via Short Link: ' + shortLink; }
    else { shortLink = "Direct"; }
    var _gaq=[['_setAccount','<%= Settings::GoogleAnalytics.code %>'],['_setDomainName','shelby.tv'],['_setCustomVar', 1, 'Visit Type', shortLink, 3],['_trackPageview']];
    (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
    g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
    s.parentNode.insertBefore(g,s);}(document,'script'));
	<% end %>

	<% if Rails.env == 'production' %>
    var _kmq = _kmq || [];
    var _kmk = _kmk || '9b8c2d291a85a66412fc8c0085125194646fd7a6';
    function _kms(u){
      setTimeout(function(){
        var d = document, f = d.getElementsByTagName('script')[0],
        s = d.createElement('script');
        s.type = 'text/javascript'; s.async = true; s.src = u;
        f.parentNode.insertBefore(s, f);
      }, 1);
    }
    _kms('//i.kissmetrics.com/i.js');
    _kms('//doug1izaerwt3.cloudfront.net/' + _kmk + '.1.js');

    var action = "Visit "+shelbyTrackingCategory;
    var shortLink = $.getUrlParam('awesm');
    if (typeof shortLink != 'undefined') {  action += ' via Short Link'; }
    else { shortLink = null; }
    _kmq.push(['record', action, {shortLink: shortLink}]);
  <% end %>

  $(document).ready(function(){
    //fanciness on focussing searching in header
    $('.js-nav-search-form-text').focus(function(){
      $(this).parent().toggleClass('focused',true);
    }).blur(function(){
      $(this).parent().toggleClass('focused',false);
    });

    // Email submit (used by many shelves) -->
    $('#js-email-form').on('submit', function(){
      $.get('<%= "#{Settings::ShelbyAPI.url}#{Settings::ShelbyAPI.version}" %>/POST/gt_interest', $(this).serialize(), function(data) {
        $('#js-email-form-submit').addClass('hidden');
        $('#js-email-form-feedback').removeClass('hidden');
      }, 'jsonp');
      return false;
    });

    $('.js-search-form, #js-nav-search-form').on('submit', function(e){
      e.preventDefault();
      var searchQuery = $(e.currentTarget).find("#query").val() || $(e.currentTarget).find("#js-nav-search-form-text").val();
      if (searchQuery) {
        if("<%= @is_mobile %>" !== "") {
          var params = {
            "q" : searchQuery,
            "max-results" : "50",
            "orderby" : "relevance"
          };

            // Create a callback
            var cb = function(res){
            // Create array of returned YouTube video URLs
            var urls = new Array();
            if (typeof res !== 'undefined'){
              res.forEach(function(r){
                if (r.link != undefined) {
                  r.link.forEach(function(l){
                    if(l.rel != undefined && l.rel == "alternate") {
                      if(l.href != undefined) {
                        urls.push(l.href);
                      }
                    }
                  });
                }
              });
            }

            if (urls.length !== 0) {
              // Get Shelby API to create genius roll based on URLs -- XXX this needs error checking
              $.post('<%= "#{Settings::ShelbyAPI.url}#{Settings::ShelbyAPI.version}" %>' + '/roll/genius', {'search': searchQuery, 'urls': JSON.stringify(urls)}, function(data){
                if (data.status == 200){
                  var _rollUrl = '<%= Settings::Application.mobile_url %>' + "/roll/" + data.result.id;
                  window.location.href = _rollUrl;
                }
                else { alert("Something went wrong, please try again."); }
              });
            }
            else { //if no URLs:
              $('.js-search__input').val('').attr('placeholder','sorry, nothing turned up');
            }
          };

          // Call ytQuery.query, passing params and your callback
          ytQuery.query(params, cb);

        } else {
          window.location.href = '/search?query=' + encodeURIComponent(searchQuery);
        }

        try {
        _gaq.push(['_trackEvent', shelbyTrackingCategory, 'search', searchQuery.toLowerCase()]);
        } catch(e) {}
      }
    });
  });
</script>
