<!DOCTYPE html>
<meta charset="utf-8">
<style>

.node {
  stroke: #fff;
  stroke-width: 1.5px;
}

.link {
  stroke: #999;
  stroke-opacity: .6;
}

</style>
<body>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
<script>

var width = 960,
    height = 500;
var jsonString ='{"nodes":[{"name":"Tsvi","group":1,"picture":"tsvi.tannin"},{"name":"Facebook","group":2,"picture":"http://localhost.shelby.tv:3000/forceGraph/images/facebook.jpg","originX":100,"originY":100},{"name":"Reece","group":1,"picture":"reece","originX":-100,"originY":100},{"name":"Vincent","group":1,"picture":"vondoom","originX":100,"originY":-100},{"name":"capucine","group":3,"picture":"KIePsbJSS04"},{"name":"sporty","group":3,"picture":"gdwchohlMjI"},{"name":"roomba","group":3,"picture":"q597neXKgFk"},{"name":"ninja","group":3,"picture":"HBfy_kjkt4I"}],"links":[{"source":0,"target":1,"value":15},{"source":0,"target":2,"value":15},{"source":0,"target":3,"value":15},{"source":2,"target":5,"value":8},{"source":5,"target":6,"value":3},{"source":6,"target":5,"value":3},{"source":2,"target":6,"value":8},{"source":1,"target":7,"value":8},{"source":3,"target":4,"value":8}]}';
var color = d3.scale.category20();

var force = d3.layout.force()
    .charge(-500)
    .linkDistance(function(d){
      //set link distance
      if (d.value==3) return 150;
      else if (d.value==8) return 120;
      else return 80;
    })
    .size([width, height]);

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);
var graph= JSON.parse(jsonString);
  force
      .nodes(graph.nodes)
      .links(graph.links)
      .start();
  //set all link data that will be rendered
  var link = svg.selectAll(".link")
      .data(graph.links)
    .enter().append("line")
      .attr("class", "link")
      .style("stroke-width", function(d) { return Math.sqrt(d.value); })
      .style("stroke", function(d){
        if (d.source.group==1) return "red";
        else if (d.source.group==2) return "blue";
        else return "orange";
      });
  //seperate the input into pictures/videos
  var pictures= [];
  var videos= [];
  for (var x in graph.nodes){
    if (graph.nodes[x].group<4) pictures.push(graph.nodes[x]); //CHANGED TO FOUR CHANGE BACK FOR VIDS
    else videos.push(graph.nodes[x]);
  }
  //set all the people data
var people = svg.selectAll(".people").data(pictures).enter()
    .append("image")
    //set picture
    .attr("xlink:href", function(d){
      if (d.group==1) {
        d.picture=propic(d.picture);
        return d.picture;     
      }
      else if (d.group==3){
      	d.picture='http://img.youtube.com/vi/'+d.picture+'/default.jpg';
      	return d.picture;
      }
      else return d.picture;
    })
    .attr("class", "people")
    .attr("name",function(d){
    	return d.name;
    })
    //set size of image
    .attr("width", function(d){
      if (d.index==0) return 65;
      else return 50; //took out /d.group
      })
    .attr("height", function(d){
      if (d.index==0) return 65;
      else return 50;
      })
    .call(force.drag);
    //set all the videos
// var things = svg.selectAll(".things").data(videos).enter()
//   .append("foreignObject")
//     .attr("width", 200)
//     .attr("height", 100)
//     .attr("class","things")
//     .append("xhtml:body")
//         .html(function(d){return '<iframe width="100%" height="100%" src="http://www.youtube.com/embed/'+d.picture+'" frameborder="0" allowfullscreen></iframe>';});
  //handle the form submit call
  	$(document).ready(function(){
	  $("#target").on('submit',function(){
	    svg.selectAll(".people").attr("xlink:href",function(d){
	      if (d.index==0) {        
	        d.picture=propic($("input:first").val());
	        return d.picture;         
	      }
	      else return d.picture; 
	    });
	    return false;
	  });
	});
  //physics work-- hook up changes to objects
  force.on("tick", function() {
    link.attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; });

    people.attr("x", function(d) { 
    	if (d.group<3 && d.name!="Tsvi") { 
    	d.x+=(graph.nodes[0].x-d.x-d.originX)*.02;
    	d.y+=(graph.nodes[0].y-d.y-d.originY)*.02;    
    	return d.x;
    }
    	else return (d.x-people[0][d.index].getAttribute("width")/2); 
    })
          .attr("y", function(d) { return (d.y-people[0][d.index].getAttribute("height")/2); });
    svg.selectAll('.things').attr("x", function(d) { return (d.x-200/2); })
          .attr("y", function(d) { return (d.y-100/2); });
  });
  //set center nodes attributes
  setpos(graph);
  force.tick();
//ajax request helper function
function propic (user){
  var link= "http://api.shelby.tv/v1/user/"+user;        
  $.ajax({
    async: false, type: "GET", url: link,
    success: function(data, textStatus ){
      link=data.result.user_image;
    },
    error : function(xhr, textStatus, errorThrown){
      link="http://www.fun-pinata-party-ideas.com/image-files/smiley-face.jpg";      
    }
  });
  return link; 
}
//set positions for elements
function setpos(graph){
  graph.nodes[0].fixed=true;
  graph.nodes[0].x=330;
  graph.nodes[0].px=330;
  graph.nodes[0].y=200;
  graph.nodes[0].py=200;
}
</script>
<form id="target">
  Username:<input type="text">
  <input type="submit" value="Go" />
</form>
</body>
</html>