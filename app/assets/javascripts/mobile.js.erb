//dependencies
//= require jquery
//= require ./backbone/underscore.js
//= require ./backbone/backbone.js

//plugins
//= require ./jquery-plugins/jquery.urlparams.js

//utils
//= require ./app/browser.js

//for sharing.
//= require ../templates/share-page-form.jst.ejs
//= require ../templates/liker-item.jst.ejs

//load event tracking js
//= require ./event-tracking/mobile.tracking.js


//COMPONENTS
//= require ./components/global.js
//= require ./components/user.js
//= require ./components/video.js
//= require ./components/frame.js
//= require ./components/dashboard_entry.js
//= require ./components/frame_interactions.js
//= require ./components/guide.js
//= require ./components/nav.js
//= require ./components/roll_header.js
//= require ./components/button.js


$(function(){
  Shelby.MobileNav = new Shelby.Navbar({
    el: $('.js-content-selector')
  });

  //init roll header OR sources lists if either of them exists
    var $userCard = $('.js-sources-list, .js-roll-header');

    if($userCard.length) {
      Shelby.UserCard = new Shelby.RollheaderView({
        el: $userCard
      });
    }
  //eo roll header

  Shelby.Guide = new Shelby.MobileGuideView({
    el: $('.js-guide')
  });

  $('body').on('click', 'a:not(.js-play-video,.js-load-more)', function(e) {
    var self = this;
    // click on any link, replace the logo with a spinner so the user can tell something is happening
    e.preventDefault();
    $('#js-header').find('.icon-mark').addClass('icon-mark--spinner');
    window.setTimeout(function() {
      window.location = $(self).attr('href');
    }, 100);
  });

  var loc      = shelbyTrackingCategory || "Mobile",
      username = shelbyTrackingLabel || "Anonymous";

  shelby.trackEx({
    providers: ['ga'],
    gaCategory: loc,
    gaAction: 'Visit page',
    gaLabel: username
  });

  $(this).on('frameLoaded', function(e) {
    var $el = $('#' + e.frame_id);
    var likers = JSON.parse($el.find('.js-likes-array').html());

    if (likers.length) {
      console.log('liekrS!!!',likers,e);
      // injectLikers(likers, $el);
    }
  });

});

// $(document).ready(function() {

//     //------FB + TWEET INTENTS ---------------//

//     var $TweetIntentButton = $('.js-tweet-intent'),
//         $FacebookMessageButton = $('.js-facebook-msg');

//     $TweetIntentButton.on('click',function(e){
//       e.preventDefault();
//       var $this = $(this),
//           url   = 'https://twitter.com/intent/tweet?related=shelby&via=shelby&url=' + $this.data('url') + '&text=' + encodeURIComponent( $this.data('video_title') );

//       window.open(url,'twitterShare','');
//     }).on('short_link',function(e){
//       shelby.trackEx({
//         providers: ['ga'],
//         gaCategory: loc,
//         gaAction: 'Anonymous Tweet Intent',
//         gaLabel: username
//       });

//       var $this = $(this);

//       if(e.code == 200) {
//         $this.removeAttr('disabled');

//         $(this).data({
//           url         : e.message,
//           video_title : e.video_title
//         });
//       }
//     });;

//     $FacebookMessageButton.on('click',function(e){
//       e.preventDefault();
//       var $data = $(this).data();
//       FB.ui(
//         {
//           caption     : 'Shelby.tv',
//           description : $data['description'],
//           display     : 'popup',
//           link        : $data['short_link'],
//           method      : 'feed',
//           name        : $data['video_title'],
//           picture     : $data['thumbnail_url'],
//         },
//         function(response) {
//           if (response && response.post_id) {
//             shelby.trackEx({
//               providers: ['ga'],
//               gaCategory: loc,
//               gaAction: 'Anonymous Facebook Share',
//               gaLabel: username
//             });
//           }
//         }
//       );

//     }).on('short_link',function(e){
//       var $this = $(this);

//       if(e.code == 200) {
//         $this.removeAttr('disabled')
//              .data({
//                 description   : e.description,
//                 thumbnail_url : e.thumbnail_url,
//                 short_link    : e.message,
//                 video_title   : e.video_title
//               });
//       }
//     });

//     //---------END FB + TWEET INTENTS ----------//

//     var updateUserAppProgress = function(user, app_progress_key) {
//       user['app_progress'][app_progress_key] = true;
//       $.ajax({
//         type: 'GET',
//         url: libs.config.shelbyGT.apiRoot + "/PUT/user/" + user.id,
//         dataType: "jsonp",
//         timeout: 10000,
//         crossDomain: true,
//         data: {
//           'app_progress': user['app_progress']
//         },
//         xhrFields: {
//           withCredentials: true
//         }
//       });
//     };

//     $('.js-sources-list,.js-roll-header').on('click', '.js-toggle-follow:not(.js-busy)', function(e) {
//       e.preventDefault();
//       var $this = $(this),
//         roll_id = $this.data('roll_id'),
//         method = $this.hasClass('button_green') ? 'join' : 'leave';

//       $this.addClass('js-busy');

//       // immediately toggle the button - if the ajax fails, we'll update the next time we render
//       var newButtonText = (method == 'join') ? 'Following' : 'Follow';
//       $this.toggleClass('button_gray button_green button_active').text(newButtonText);

//       $.ajax({
//         type: 'GET',
//         url: libs.config.shelbyGT.apiRoot + '/POST/roll/' + roll_id + '/' + method,
//         dataType: "jsonp",
//         timeout: 10000,
//         crossDomain: true,
//         data: {
//           roll_id: roll_id
//         },
//         xhrFields: {
//           withCredentials: true
//         },
//         success: function(response) {
//           var user = JSON.parse($('#js-user').text());
//           if (user.user_type == libs.config.userTypes.anonymous && typeof user.app_progress.followedSource == "undefined") {
//             updateUserAppProgress(user, "followedSources");
//           }
//           $this.removeClass('js-busy');
//         },
//         error: function(e) {
//           $this.removeClass('js-busy');
//         }
//       });

//     });

//   }



//   var $userLike = $('#js-user-like').html();

//   var appendAvatar = function(frame_id) {
//     var $frame = $('#' + frame_id);
//     $likes = $frame.find('.js-frame-likes');

//     // if the logged in user is already in the list, don't add that user again
//     if (_(JSON.parse($frame.find('.js-likes-array').html())).indexOf(user.id) != -1) {
//       return;
//     }

//     // append the user to the list:
//     $likes.children('.js-liker-avatars-list').append($userLike);
//   };

// });
