//dependencies
//= require jquery
//= require ./backbone/underscore.js
//= require ./backbone/backbone.js

//plugins
//= require ./jquery-plugins/jquery.urlparams.js

//utils
//= require ./app/browser.js

//for sharing.
//= require ../templates/share-page-form.jst.ejs
// = require ../templates/liker-item.jst.ejs

//load event tracking js
//= require ./event-tracking/mobile.tracking.js

//COMPONENTS
//= require ./components/global.js
//= require ./components/user.js
//= require ./components/video.js
//= require ./components/frame.js
//= require ./components/dashboard_entry.js
//= require ./components/frame_interactions.js
//= require ./components/guide.js
//= require ./components/nav.js

$(function(){
  Shelby.MobileNav = new Shelby.Navbar({
    el: $('.js-content-selector')
  });

  Shelby.Guide = new Shelby.MobileGuideView({
    el: $('.js-guide')
  });


//   $('.js-load-more').on('click', function(e) {
//     e.preventDefault();

//     var $this = $(this).addClass('button_busy');

//     window.setTimeout(function() {
//       $.get($this.attr('href'), function(data) {
//         $this.removeClass('button_busy');

//         var $items = $(data).find('.js-list').children('.list__item'),
//           $button = $(data).find('.js-load-more');

//         $('.js-list').append($items);
//         $('.js-load-more').attr('href', $button.attr('href'));

//         _($items.children('.js-frame')).each(function(item) {
//           var $el = $(item);
//           var $likers = $el.find('.js-likes-array');

//           if ($likers && $likers.length) {
//             $likers = JSON.parse($likers.html());
//             injectLikers($likers, $el);
//           }
//         });
//       });
//     }, 100);
//   });


  $('body').on('click', 'a:not(.js-play-video,.js-load-more)', function(e) {
    var self = this;
    // click on any link, replace the logo with a spinner so the user can tell something is happening
    e.preventDefault();
    $('#js-header').find('.icon-mark').addClass('icon-mark--spinner');
    window.setTimeout(function() {
      window.location = $(self).attr('href');
    }, 100);
  });

  var loc      = shelbyTrackingCategory || "Mobile",
      username = shelbyTrackingLabel || "Anonymous";

  shelby.trackEx({
    providers: ['ga'],
    gaCategory: loc,
    gaAction: 'Visit page',
    gaLabel: username
  });
});

// $(document).ready(function() {

//     //------FB + TWEET INTENTS ---------------//

//     var $TweetIntentButton = $('.js-tweet-intent'),
//         $FacebookMessageButton = $('.js-facebook-msg');

//     $TweetIntentButton.on('click',function(e){
//       e.preventDefault();
//       var $this = $(this),
//           url   = 'https://twitter.com/intent/tweet?related=shelby&via=shelby&url=' + $this.data('url') + '&text=' + encodeURIComponent( $this.data('video_title') );

//       window.open(url,'twitterShare','');
//     }).on('short_link',function(e){
//       shelby.trackEx({
//         providers: ['ga'],
//         gaCategory: loc,
//         gaAction: 'Anonymous Tweet Intent',
//         gaLabel: username
//       });

//       var $this = $(this);

//       if(e.code == 200) {
//         $this.removeAttr('disabled');

//         $(this).data({
//           url         : e.message,
//           video_title : e.video_title
//         });
//       }
//     });;

//     $FacebookMessageButton.on('click',function(e){
//       e.preventDefault();
//       var $data = $(this).data();
//       FB.ui(
//         {
//           caption     : 'Shelby.tv',
//           description : $data['description'],
//           display     : 'popup',
//           link        : $data['short_link'],
//           method      : 'feed',
//           name        : $data['video_title'],
//           picture     : $data['thumbnail_url'],
//         },
//         function(response) {
//           if (response && response.post_id) {
//             shelby.trackEx({
//               providers: ['ga'],
//               gaCategory: loc,
//               gaAction: 'Anonymous Facebook Share',
//               gaLabel: username
//             });
//           }
//         }
//       );

//     }).on('short_link',function(e){
//       var $this = $(this);

//       if(e.code == 200) {
//         $this.removeAttr('disabled')
//              .data({
//                 description   : e.description,
//                 thumbnail_url : e.thumbnail_url,
//                 short_link    : e.message,
//                 video_title   : e.video_title
//               });
//       }
//     });

//     //---------END FB + TWEET INTENTS ----------//

//     var updateUserAppProgress = function(user, app_progress_key) {
//       user['app_progress'][app_progress_key] = true;
//       $.ajax({
//         type: 'GET',
//         url: libs.config.shelbyGT.apiRoot + "/PUT/user/" + user.id,
//         dataType: "jsonp",
//         timeout: 10000,
//         crossDomain: true,
//         data: {
//           'app_progress': user['app_progress']
//         },
//         xhrFields: {
//           withCredentials: true
//         }
//       });
//     };

//     $('.js-sources-list,.js-roll-header').on('click', '.js-toggle-follow:not(.js-busy)', function(e) {
//       e.preventDefault();
//       var $this = $(this),
//         roll_id = $this.data('roll_id'),
//         method = $this.hasClass('button_green') ? 'join' : 'leave';

//       $this.addClass('js-busy');

//       // immediately toggle the button - if the ajax fails, we'll update the next time we render
//       var newButtonText = (method == 'join') ? 'Following' : 'Follow';
//       $this.toggleClass('button_gray button_green button_active').text(newButtonText);

//       $.ajax({
//         type: 'GET',
//         url: libs.config.shelbyGT.apiRoot + '/POST/roll/' + roll_id + '/' + method,
//         dataType: "jsonp",
//         timeout: 10000,
//         crossDomain: true,
//         data: {
//           roll_id: roll_id
//         },
//         xhrFields: {
//           withCredentials: true
//         },
//         success: function(response) {
//           var user = JSON.parse($('#js-user').text());
//           if (user.user_type == libs.config.userTypes.anonymous && typeof user.app_progress.followedSource == "undefined") {
//             updateUserAppProgress(user, "followedSources");
//           }
//           $this.removeClass('js-busy');
//         },
//         error: function(e) {
//           $this.removeClass('js-busy');
//         }
//       });

//     });

//   }

//   //does not depend on user model
//   $('.js-load-more').on('click', function(e) {
//     e.preventDefault();

//     var $this = $(this).addClass('button_busy');

//     window.setTimeout(function() {
//       $.get($this.attr('href'), function(data) {
//         $this.removeClass('button_busy');

//         var $items = $(data).find('.js-list').children('.list__item'),
//           $button = $(data).find('.js-load-more');

//         $('.js-list').append($items);
//         $('.js-load-more').attr('href', $button.attr('href'));

//         _($items.children('.js-frame')).each(function(item) {
//           var $el = $(item);
//           var $likers = $el.find('.js-likes-array');

//           if ($likers && $likers.length) {
//             $likers = JSON.parse($likers.html());
//             injectLikers($likers, $el);
//           }
//         });
//       });
//     }, 100);
//   });

//   var $frameLikeList = $('#js-frame-like').html();

//   $('.js-list').on('click', '.js-like', function(e) {
//     var $this = $(this);

//     //prevent extraneous api calls
//     if ($this.hasClass('visuallydisabled')) {
//       return false;
//     }

//     e.preventDefault();

//     var frame_id = $this.data('frame_id'),
//       $frame = $(e.delegateTarget).find('#' + frame_id),
//       $likes = $frame.find('.js-frame-likes'),
//       data = {
//         frame_id: frame_id
//       };

//     //modify the button state/appearance
//     $this.addClass('visuallydisabled').children('.icon-like').addClass('icon-like--red');

//     if (!$likes.length) {
//       //if no one Liked the Frame yet, add the Like list container:
//       $frame.append($frameLikeList);
//     }

//     if (user && user.nickname != "Anonymous" && user.user_type != libs.config.userTypes.anonymous) {
//       //non-anonymous users get their avatar added to the liker list
//       appendAvatar(frame_id)
//     } else {
//       //anonymous users get added to the liker count
//       var $total = $frame.find('.js-like-total');
//       $total.text('+ ' + (parseInt($total.text().split('+')[1].trim()) + 1)).removeClass('invisible');
//     }

//     $.ajax({
//       type: 'GET',
//       url: libs.config.shelbyGT.apiRoot + '/PUT/frame/' + frame_id + '/like',
//       dataType: "jsonp",
//       timeout: 10000,
//       crossDomain: true,
//       data: data,
//       xhrFields: {
//         withCredentials: true
//       },
//       success: function() {},
//       error: function() {}
//     });

//   });

//   var $userLike = $('#js-user-like').html();

//   var appendAvatar = function(frame_id) {
//     var $frame = $('#' + frame_id);
//     $likes = $frame.find('.js-frame-likes');

//     // if the logged in user is already in the list, don't add that user again
//     if (_(JSON.parse($frame.find('.js-likes-array').html())).indexOf(user.id) != -1) {
//       return;
//     }

//     // append the user to the list:
//     $likes.children('.js-liker-avatars-list').append($userLike);
//   };

//   var injectLikers = function(likers, $scope) {
//     if (likers.length) {
//       var data = {
//         ids: likers.join(',')
//       };

//       $.ajax({
//         type: 'GET',
//         url: libs.config.shelbyGT.apiRoot + '/user',
//         dataType: "jsonp",
//         timeout: 10000,
//         crossDomain: true,
//         data: data,
//         xhrFields: {
//           withCredentials: true
//         },
//         success: function(response) {
//           $scope.find('.js-liker-avatars-list').empty();

//           for (var i = 0; i < response.result.length; i++) {

//             var user = response.result[i],
//               avatar;

//             if (!user) {
//               avatar = "/images/assets/avatar.png";
//             } else if (user.has_shelby_avatar) {
//               avatar = libs.config.avatarUrlRoot + '/' + libs.config.shelbyGT.UserAvatarSizes.small + '/' + user.id + '?' + new Date(user.avatar_updated_at).getTime();
//             } else {
//               avatar = (user.user_image_original != 'null' && user.user_image_original) || (user.user_image != 'null' && user.user_image) || "/images/assets/avatar.png";
//             }

//             var appropriatePath = appropriateSubdirectory;

//             $scope.find('.js-liker-avatars-list').append(SHELBYJST['liker-item']({
//               avatar: avatar,
//               liker: user,
//               appropriatePath: appropriatePath
//             }));
//           }
//         },
//         error: function(e) {
//           console.log("Oops!", e.statusText);
//         }
//       });
//     }
//   };

//   $(this).on('frameLoaded', function(e) {
//     var $el = $('#' + e.frame_id);
//     var likers = JSON.parse($el.find('.js-likes-array').html());

//     if (likers.length) {
//       injectLikers(likers, $el);
//     }
//   });
// });
