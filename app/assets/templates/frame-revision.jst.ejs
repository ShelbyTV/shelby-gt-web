<% var messages = (frame.get('conversation') && frame.get('conversation').get('messages')) || [] %>
<% var comment; if(messages.models.length > 0){ comment = messages.models[0].get('text') } %>

<% var user = shelby.models.user %>
<% var userNickname = user.get('nickname') %>

<% var video = frame.get('video') %>
<% var videoId = frame.get('id') %>
<% var videoTitle = video.get('title') %>
<% var videoThumbnail = video.get('thumbnail_url') %>

<% var creator = frame.get('creator') %>
<% var creatorNickname = creator.get('nickname') %>
<% var creatorAvatar = creator.get('user_image') %>
<% /* TODO: REMOVE THIS and MOVE TO template param obj*/ %> <% var messages = (frame.get('conversation') && frame.get('conversation').get('messages')) || [] %>


<% var isFaux = libs.shelbyGT.viewHelpers.roll.isFaux(frame.get('roll')) %>
<% var frameIsOnHeartedRoll = !user.get('anon') && frame.isOnRoll(user.get('heart_roll_id')) %>
<% var frameIsOnWatchLaterRoll = !user.get('anon') && frame.isOnRoll(user.get('watch_later_roll_id')) %>
<% var contextOverlay = options.contextOverlay %>
<% var frameViewed = !contextOverlay && frameGroup.get('collapsed') %>
<% var clickableCreator = (shelby.models.guide.get('displayState') == libs.shelbyGT.DisplayState.dashboard ||
                                                                      frameIsOnHeartedRoll ||
                                                                      frameIsOnWatchLaterRoll)
%>


<!-- new videocard -->
<article id="<%= videoId %>" class="xframe<%= (frameViewed) ? ' xframe-collapsed' : ''%>">
  <% if (!frameViewed) { %>
    <a href="#" onclick="return false;" class="xframe-header js-frame-activate">
      <h1 class="xframe-title" title="<%= videoTitle %>">
       <%= videoTitle %>
      </h1>
    </a>
  <% } %>

  <div class="xframe-body-wrapper clearfix">
    <div class="xframe-body">
      <div class="menu_module xframe-menu">
        <ul class="menu_list xframe-command-menu xframe-list" role="menubar">
          <li class="menu_item" role="menuitem">
            <button class="xframe-command command-queue js-queue-frame<%= (queuedVideosModel.videoIsInQueue(video) ) ? ' queued' : '' %>">
              <i class="command-icon">
                <%= (queuedVideosModel.videoIsInQueue(video) ) ? 'Queued' : 'Queue' %>
              </i>
            </button>
          </li>
          <li class="menu_item" role="menuitem">
            <button class="xframe-command command-roll js-roll-frame js-track-event" data-ga_category="Frame" data-ga_action="Click roll" data-ga_label="<%= userNickname %>">
              <i class="command-icon">
                Rollâ€¦
              </i>
            </button>
          </li>
          <li class="menu_item right command-sublist" aria-haspopup="true">
            <button class="menu_sublist_anchor xframe-command command-more">
              <i class="command-icon">
                More
              </i>
            </button>
            <ul class="menu_sublist xframe-sublist" role="menu">
              <li class="menu_option xframe-item" role="menuitem">
                <button class="xframe-option command-share js-share-frame">
                  Share Video
                </button>
              </li>
              <% if (creator===shelby.models.user || shelby.models.guide.get('displayState')==='watchLaterRoll') { %>
                <li class="menu_option xframe-item" role="menuitem">
                  <button class="xframe-option command-remove js-remove-frame">
                    Remove Video
                  </button>
                </li>
              <% } %>
            </ul>
          </li>
        </ul>
      </div><!-- eo .xframe-menu -->
      <a href="#" onclick="return false;" class="image_module xframe-thumbnail js-frame-activate<%= (!videoThumbnail) ? ' missing-thumbnail' : '' %>" style="background-image: url('<%= videoThumbnail %>');" role="img">
        <img class="visuallyhidden" src="<%= videoThumbnail %>" title="<%= videoTitle %>" alt="<%= videoTitle %> thumbnail">
      </a>
        <!-- <div class="xframe-thumbnail xframe-thumbnail-missing"></div> -->
    </div><!-- eo .xframe-body -->

    <footer class="media_module xframe-footer clearfix">
      <% if (!frameViewed) { %>
        <a href="#" onclick="return false;" class="media_image">
          <span class="image_module xuser-avatar" style="background-image: url(<%= creatorAvatar %>);" role="img">
            <img src="<%= creatorAvatar %>" class="visuallyhidden" title="<%= creatorNickname %>" alt="<%= creatorNickname %>">
          </span>
        </a>
      <% } %>

      <div class="media_body">
        <% if (!frameViewed) { %>
          <p class="xuser-data">
            <% if (clickableCreator && !isFaux) { %>
              shared by <a href="#" onclick="return false;" class="js-creator-personal-roll no-faux-link"><strong><%= creatorNickname %></strong></a>
            <% } else { %>
              shared by <%= creatorNickname %>
            <% } %>

            <span class="xuser-data-timestamp">
               <%= frame.get('created_at') %>
            </span>
          </p>

          <% if(messages.models.length > 0 && creator.get('id') == messages.models[0].get('user_id')) { %>
            <p>
              <%= messages.models[0].get('text') %>
            </p>
          <% } %>

          <div class="xframe-subline">
            <a href="#" onclick="return false;" class="xframe-link xframe-comment-link js-video-activity-toggle js-track-event js-video-activity-toggle-comment" data-ga_category="Frame" data-ga_action="Click show conversation" data-ga_label="<%= userNickname %>">
              <%= (messages.length <= 1) ? 'Leave a comment' : 'Comments (' + messages.length + ')' %>
            </a>
          </div>
        <% } else { %>
          <a href="#" onclick="return false;" class="xframe-header js-frame-activate">
            <h1 class="xframe-title" title="<%= videoTitle %>">
             <%= videoTitle %>
            </h1>

            <p class="xuser-data">
              shared by <%= creatorNickname %>
            </p>
          </a>
        <% } %>
      </div>
    </footer><!-- eo .media_module-->
  </div><!-- eo .xframe-body-wrapper -->
  <% if (!contextOverlay) { %>
    <% var firstLink = true %>
    <% var dupeFrameRollIds = [frameGroup.get('frames').at(0).get('roll').get('id')] %>
    <% for (var i = 1; i < frameGroup.get('frames').length; i++) { %>
      <% var dupeFrame = frameGroup.get('frames').at(i) %>
      <% var dupeCreator = dupeFrame.get('creator') %>
      <% var dupeCreatorNickname = dupeCreator ? dupeCreator.get('nickname') : "" %>
      <% var dupeFrameIsOnHeartedRoll = !shelby.models.user.get('anon') && dupeFrame.isOnRoll(shelby.models.user.get('heart_roll_id')) %>
      <% var dupeFrameIsOnWatchLaterRoll = !shelby.models.user.get('anon') && dupeFrame.isOnRoll(shelby.models.user.get('watch_later_roll_id')) %>
      <% var linkText = "" %>
      
      <% if (dupeFrame.get('roll') && $.inArray(dupeFrame.get('roll').get('id'), dupeFrameRollIds) != -1) { %>
      <%   continue; %>
      <% } %>

      <% if (dupeFrameIsOnHeartedRoll && dupeCreatorNickname != "") { %>
         <% linkText = dupeCreatorNickname + "'s Likes" %>
      <% } else if (dupeFrameIsOnWatchLaterRoll && dupeCreatorNickname != "") { %>
        <% linkText = dupeCreatorNickname + "'s Queue" %>
      <% } else if (!dupeFrameIsOnHeartedRoll && !dupeFrameIsOnWatchLaterRoll && dupeFrame.get('roll')) { %>
         <% linkText = dupeFrame.get('roll').get('title') %>
      <% } else { %>
         <% continue; %>
      <% } %>

      <% dupeFrameRollIds.push(dupeFrame.get('roll').get('id')) %>
      <% if (firstLink) { %>
        <div class="framegroup-dupes">
        <h1 class="framegroup-dupe-text">
        + Also rolled by <% firstLink = false %>
      <% } %>

      <% var commaOrNot = dupeFrameRollIds.length > 2 ? ", " : "" %>
      <%= commaOrNot %><a href="#" data-roll_id="<%= dupeFrame.get('roll').get('id') %>" data-frame_id="<%= dupeFrame.get('id') %>" class="js-go-to-frame-and-roll-by-id"><%= linkText %></a>
    <% } %>
    <% if (!firstLink) { %>
      </h1>
      </div>
    <% } %>
  <% } /* end of contextOverlay */ %>
</article>
<!-- end new videocard -->
